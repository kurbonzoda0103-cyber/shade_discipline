<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shade: Black Discipline</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding: 20px; overflow: hidden; }
        .status { color: #444; text-transform: uppercase; letter-spacing: 3px; font-size: 12px; margin-top: 10px; }
        .balance { font-size: 32px; color: #ff4d4d; margin: 20px 0; font-weight: bold; text-shadow: 0 0 10px rgba(255,77,77,0.3); }
        .main-btn { 
            width: 240px; height: 240px; border-radius: 50%; border: 2px solid #222;
            background: url('https://i.ibb.co/L9C5x9s/cyborg-art.png') center/cover;
            margin: 30px auto; box-shadow: 0 0 30px rgba(255,77,77,0.1);
            transition: all 0.5s ease;
        }
        .mining-active { box-shadow: 0 0 50px rgba(255,77,77,0.5); border-color: #ff4d4d; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        .action-btn { 
            background: #ff4d4d; color: #000; padding: 18px 50px; 
            border: none; border-radius: 12px; font-weight: 900; font-size: 16px; 
            cursor: pointer; box-shadow: 0 4px 15px rgba(255,77,77,0.4);
        }
        #timer { font-family: monospace; font-size: 20px; color: #888; margin-top: 15px; display: none; }
    </style>
</head>
<body>
    <div class="status">Protocol: Black Discipline</div>
    <div class="balance">$SHADE: <span id="score">0</span></div>
    <div id="visual" class="main-btn"></div>
    <button id="btn" class="action-btn" onclick="toggleMining()">АКТИВИРОВАТЬ СОН</button>
    <div id="timer">00:00:00</div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation(); // Подтверждение закрытия, чтобы не вышли случайно

        let startTime;
        let isMining = false;
        let timerInterval;

        function toggleMining() {
            let btn = document.getElementById('btn');
            let visual = document.getElementById('visual');
            let timerDisplay = document.getElementById('timer');

            if (!isMining) {
                // СТАРТ
                isMining = true;
                startTime = new Date();
                btn.innerText = "ПРЕРВАТЬ ПРОТОКОЛ";
                btn.style.background = "#222";
                btn.style.color = "#ff4d4d";
                visual.classList.add('mining-active');
                timerDisplay.style.display = "block";
                
                timerInterval = setInterval(updateTimer, 1000);
            } else {
                // ФИНИШ
                isMining = false;
                clearInterval(timerInterval);
                let endTime = new Date();
                let diff = Math.floor((endTime - startTime) / 1000); // Секунды
                
                // Начисление (условно 1 сек = 1 токен для теста)
                let earned = Math.floor(diff / 5); // 1 токен за 5 секунд теста
                alert("Протокол завершен. Вы заработали: " + earned + " $SHADE");
                
                // Отправляем данные в бот
                tg.sendData(JSON.stringify({action: "sleep_done", amount: earned}));
                
                // Сброс интерфейса
                btn.innerText = "АКТИВИРОВАТЬ СОН";
                btn.style.background = "#ff4d4d";
                btn.style.color = "#000";
                visual.classList.remove('mining-active');
                timerDisplay.style.display = "none";
            }
        }

        function updateTimer() {
            let now = new Date();
            let diff = Math.floor((now - startTime) / 1000);
            let h = Math.floor(diff / 3600).toString().padStart(2, '0');
            let m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
            let s = (diff % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = h + ":" + m + ":" + s;
        }
    </script>
</body>
</html>
